---
sidebar_position: 15
title: "Migraciones de Base de Datos con Execution Hooks"
description: "Cómo configurar y gestionar migraciones de base de datos usando SleakOps Execution Hooks"
date: "2024-12-19"
category: "workload"
tags: ["base de datos", "migraciones", "hooks", "ejecuciones", "despliegue"]
---

import TroubleshootingItem from "@site/src/components/HomepageFeatures/troubleshootingitem";

# Migraciones de Base de Datos con Execution Hooks

**Fecha:** 19 de diciembre de 2024  
**Categoría:** Carga de trabajo  
**Etiquetas:** Base de datos, Migraciones, Hooks, Ejecuciones, Despliegue

## Descripción del Problema

**Contexto:** Los usuarios necesitan ejecutar migraciones de base de datos como parte de su proceso de despliegue en SleakOps, específicamente para aplicaciones .NET que usan migraciones de Entity Framework.

**Síntomas observados:**

- Necesidad de ejecutar comandos `dotnet ef database update` durante los despliegues
- Incertidumbre sobre cuándo y cómo deben ejecutarse las migraciones en la canalización CI/CD
- Preguntas sobre ejecutar migraciones independientemente de los despliegues
- Necesidad de ejecución automática de migraciones antes de las actualizaciones de código

**Configuración relevante:**

- Entorno: Entornos de Desarrollo y Producción
- Framework: .NET con Entity Framework
- Comando de migración: `dotnet ef database update`
- Tipo de hook: `pre-upgrade`
- Tipo de ejecución: Hook y Job

**Condiciones de error:**

- Migraciones que no se ejecutan automáticamente durante los despliegues
- Necesidad de ejecutar migraciones sin activar un despliegue completo
- Integración de comandos de migración en el proceso de construcción

## Solución Detallada

<TroubleshootingItem id="automatic-hooks" summary="Migraciones Automáticas de Base de Datos con Hooks Pre-upgrade">

SleakOps ofrece soporte integrado para migraciones de base de datos mediante Execution Hooks:

**Cómo funciona:**

1. **Hooks pre-upgrade**: Se crean automáticamente como hooks `db-migration` en tus entornos
2. **Ejecución automática**: Se ejecutan antes de cada despliegue cuando haces push en las ramas `develop` o `main`
3. **Ejecución de comando**: Ejecuta el comando `update-database` antes de actualizar el código de la aplicación

**Configuración:**

```yaml
# Configuración del hook (creado automáticamente)
name: db-migration
type: pre-upgrade
command: dotnet ef database update --project YourProject.csproj
```

**Flujo del proceso:**

1. Hacer push de código a la rama `develop` o `main`
2. CI/CD dispara el proceso de Build
3. Inicia el despliegue
4. **Se ejecuta el hook pre-upgrade** → Se ejecuta la migración de base de datos
5. El código de la aplicación se actualiza en el clúster

Esto significa que las migraciones se ejecutan automáticamente con cada despliegue, por lo que normalmente no es necesario ejecutar migraciones manualmente antes de las compilaciones.

</TroubleshootingItem>

<TroubleshootingItem id="manual-job-execution" summary="Ejecución Manual de Migraciones con Ejecuciones de Tipo Job">

Para ejecutar migraciones independientemente de los despliegues:

**Crear una ejecución de tipo Job:**

1. Ve a tu proyecto en SleakOps
2. Navega a la sección **Ejecuciones**
3. Crea una nueva ejecución con tipo **Job**
4. Configura el comando de migración

**Configuración del Job:**

```yaml
name: manual-db-migration
type: job
command: dotnet ef database update --project YourProject.csproj
```

**Características:**

- **Ejecución única:** Se ejecuta solo cuando se activa manualmente
- **Independiente:** No afecta despliegues ni compilaciones
- **Bajo demanda:** Ejecuta cuando necesites correr migraciones manualmente

**Casos de uso:**

- Correcciones de emergencia en la base de datos
- Pruebas de migraciones en staging
- Escenarios de reversión
- Configuración inicial de la base de datos

</TroubleshootingItem>

<TroubleshootingItem id="dockerfile-integration" summary="Integración en el Proceso de Construcción vía Dockerfile">

Para ejecutar migraciones durante el proceso de construcción (no recomendado como enfoque principal):

**Agregar comando de migración al Dockerfile:**

```dockerfile
# Contenido existente de tu Dockerfile
WORKDIR /app
COPY . .

# Agregar comando de migración antes de CMD
RUN dotnet ef database update --project ../Netdo.Firev.WebApi/Netdo.Firev.WebApi.csproj

# Instrucción CMD existente
CMD ["dotnet", "YourApp.dll"]
```

**Consideraciones importantes:**

- **Conectividad a la base de datos:** Asegurar que la base de datos esté accesible durante la construcción
- **Cadenas de conexión:** Deben estar disponibles en tiempo de construcción
- **Entorno de construcción:** El servidor de base de datos debe ser accesible desde el entorno de build
- **Seguridad:** Evitar exponer credenciales de producción en el proceso de construcción

**Enfoque alternativo usando construcciones multi-stage:**

```dockerfile
# Etapa de build
FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build
WORKDIR /src
COPY . .
RUN dotnet restore
RUN dotnet build

# Etapa de migración (opcional)
FROM build AS migration
RUN dotnet ef database update --project YourProject.csproj

# Etapa de runtime
FROM mcr.microsoft.com/dotnet/aspnet:6.0 AS runtime
WORKDIR /app
COPY --from=build /src/published .
CMD ["dotnet", "YourApp.dll"]
```

</TroubleshootingItem>

<TroubleshootingItem id="best-practices" summary="Mejores Prácticas y Recomendaciones">

**Enfoque recomendado:**

1. **Usar hooks pre-upgrade** (comportamiento por defecto de SleakOps) para migraciones automáticas
2. **Crear ejecuciones de tipo Job** para migraciones manuales/emergencias
3. **Evitar migraciones en Dockerfile** a menos que requisitos específicos lo demanden

**Lista de verificación para estrategia de migración:**

- ✅ Verificar que los hooks pre-upgrade estén configurados en todos los entornos
- ✅ Probar migraciones primero en entorno de desarrollo
- ✅ Crear ejecución tipo Job para capacidad de migración manual
- ✅ Asegurar que las cadenas de conexión a base de datos estén configuradas correctamente
- ✅ Monitorear logs de ejecución de migraciones durante despliegues

**Solución de problemas comunes:**

- **Hook no se ejecuta:** Verificar que el hook exista en la configuración del entorno
- **Fallos de conexión:** Verificar conectividad a base de datos desde el clúster
- **Errores de permisos:** Asegurar que la cuenta de servicio tenga acceso a la base de datos
- **Conflictos de migración:** Revisar el historial de migraciones de Entity Framework

**Consideraciones específicas por entorno:**

- **Desarrollo:** Migraciones frecuentes, usar hooks automáticos
- **Staging:** Probar migraciones antes de producción, usar hooks y jobs
- **Producción:** Planificación cuidadosa de migraciones, respaldo previo a migración

</TroubleshootingItem>

---

_Esta FAQ fue generada automáticamente el 19 de diciembre de 2024 basada en una consulta real de usuario._
