---
sidebar_position: 3
title: "Configuración de Registro en Docker para Aplicaciones Daphne"
description: "Cómo configurar contenedores Docker para capturar y mostrar los registros de aplicaciones Daphne"
date: "2025-01-21"
category: "workload"
tags: ["docker", "daphne", "logging", "django", "troubleshooting"]
---

import TroubleshootingItem from "@site/src/components/HomepageFeatures/troubleshootingitem";

# Configuración de Registro en Docker para Aplicaciones Daphne

**Fecha:** 21 de enero de 2025  
**Categoría:** Carga de trabajo  
**Etiquetas:** Docker, Daphne, Registro, Django, Solución de problemas

## Descripción del Problema

**Contexto:** El usuario necesita configurar un contenedor Docker que ejecuta una aplicación Django con el servidor ASGI Daphne para capturar y mostrar correctamente los registros de la aplicación a través del sistema de registro de Docker.

**Síntomas observados:**

- Los registros de la aplicación no son visibles en los registros del contenedor Docker
- Los registros del servidor Daphne no están siendo capturados por Docker
- Los parámetros estándar de registro de Docker (`stdin_open: true`, `tty: true`) no son suficientes
- La aplicación tiene configurado el registro pero la salida no llega al stdout de Docker

**Configuración relevante:**

- Aplicación: Django con servidor ASGI Daphne
- Orquestación de contenedores: Docker Compose
- Parámetros actuales: `stdin_open: true` y `tty: true`
- Logger configurado para Daphne en la aplicación

**Condiciones de error:**

- Se generan registros en la aplicación pero no son visibles en los logs de Docker
- La configuración estándar de registro de Docker es insuficiente para Daphne
- Es necesario redirigir los registros de la aplicación a los flujos stdout/stderr de Docker

## Solución Detallada

<TroubleshootingItem id="redirect-logs-stdout" summary="Redirigir los registros de Daphne a stdout">

La solución principal es configurar Daphne para que envíe los registros directamente a `/dev/stdout`, que Docker puede capturar:

**Método 1: Configuración por línea de comandos**

```dockerfile
# En tu Dockerfile o comando de docker-compose.yml
CMD ["daphne", "-b", "0.0.0.0", "-p", "8000", "--access-log", "/dev/stdout", "--proxy-headers", "myproject.asgi:application"]
```

**Método 2: Variable de entorno**

```yaml
# docker-compose.yml
services:
  web:
    environment:
      - DAPHNE_ACCESS_LOG=/dev/stdout
      - DAPHNE_ERROR_LOG=/dev/stderr
```

</TroubleshootingItem>

<TroubleshootingItem id="django-logging-config" summary="Configurar los ajustes de logging de Django">

Actualiza tu `settings.py` de Django para asegurar que los registros se dirigen a stdout:

```python
# settings.py
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'stream': 'ext://sys.stdout',
            'formatter': 'verbose',
        },
        'daphne': {
            'class': 'logging.StreamHandler',
            'stream': 'ext://sys.stdout',
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
    'loggers': {
        'daphne': {
            'handlers': ['daphne'],
            'level': 'INFO',
            'propagate': False,
        },
        'django': {
            'handlers': ['console'],
            'level': 'INFO',
            'propagate': False,
        },
    },
}
```

</TroubleshootingItem>

<TroubleshootingItem id="docker-compose-configuration" summary="Configuración completa de docker-compose.yml">

Aquí tienes un ejemplo completo de cómo configurar tu `docker-compose.yml`:

```yaml
version: "3.8"

services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DEBUG=1
      - PYTHONUNBUFFERED=1 # Importante para salida de logs en tiempo real
    command: >
      daphne 
      --bind 0.0.0.0 
      --port 8000 
      --access-log /dev/stdout 
      --proxy-headers 
      myproject.asgi:application
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Elimina estos si no son necesarios para tu caso de uso
    # stdin_open: true
    # tty: true
```

</TroubleshootingItem>

<TroubleshootingItem id="dockerfile-optimization" summary="Optimizaciones del Dockerfile para logging">

Optimiza tu Dockerfile para un mejor registro:

```dockerfile
FROM python:3.11-slim

# Establecer variables de entorno para mejor logging
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Copiar requirements e instalar dependencias
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copiar código de la aplicación
COPY . .

# Crear un usuario no root
RUN useradd --create-home --shell /bin/bash app
USER app

# Exponer puerto
EXPOSE 8000

# Iniciar Daphne con logging adecuado
CMD ["daphne", "-b", "0.0.0.0", "-p", "8000", "--access-log", "/dev/stdout", "--proxy-headers", "myproject.asgi:application"]
```

</TroubleshootingItem>

<TroubleshootingItem id="troubleshooting-tips" summary="Solución de problemas y verificación">

**Verifica que los logs funcionen:**

```bash
# Ver registros del contenedor
docker-compose logs -f web

# O para un contenedor específico
docker logs -f <nombre_contenedor>
```

**Problemas comunes y soluciones:**

1. **Los logs aún no aparecen:** Asegúrate de que `PYTHONUNBUFFERED=1` esté configurado
2. **Logs parciales:** Verifica si tu aplicación usa print en lugar de logging adecuado
3. **Problemas de rendimiento:** Considera usar logging estructurado (formato JSON)

**Prueba la configuración de logging:**

```python
# Agrega esto a tus vistas de Django o comandos de gestión
import logging
logger = logging.getLogger(__name__)

def test_view(request):
    logger.info("Mensaje de prueba de log desde vista Django")
    return HttpResponse("Revisa los logs de Docker para el mensaje")
```

**Logging avanzado con salida estructurada:**

```python
# Para logs estructurados en JSON
LOGGING = {
    'version': 1"
}
```
