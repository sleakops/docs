---
sidebar_position: 15
title: "Restauración de Base de Datos en Entorno Pod"
description: "Procedimientos para restaurar volcados de bases de datos en pods de Kubernetes con resiliencia en la conexión"
date: "2024-03-21"
category: "dependency"
tags: ["base de datos", "restauración", "volcado", "pod", "tmux", "kubernetes"]
---

import TroubleshootingItem from "@site/src/components/HomepageFeatures/troubleshootingitem";

# Restauración de Base de Datos en Entorno Pod

**Fecha:** 21 de marzo de 2024  
**Categoría:** Dependencia  
**Etiquetas:** Base de datos, Restauración, Volcado, Pod, Tmux, Kubernetes

## Descripción del Problema

**Contexto:** Al realizar operaciones de restauración de bases de datos en pods de Kubernetes, los usuarios necesitan procedimientos confiables para manejar archivos de volcado grandes manteniendo la estabilidad de la conexión durante procesos largos de restauración.

**Síntomas Observados:**

- Caídas de conexión durante operaciones largas de restauración de base de datos
- Problemas de espacio en volumen debido a acumulación de archivos de volcado antiguos
- Necesidad de persistencia de sesión durante procesos de restauración
- Requisito de monitoreo del progreso de la restauración

**Configuración Relevante:**

- Entorno: Restauración de base de datos en producción
- Plataforma: Pods de Kubernetes
- Herramientas: Archivos de volcado de base de datos, tmux para gestión de sesiones
- Almacenamiento: Volúmenes de pod con espacio limitado

**Condiciones de Error:**

- Tiempo de espera de conexión durante operaciones de restauración
- Espacio insuficiente en disco para archivos de volcado
- Interrupción del proceso por problemas de red
- Pérdida del progreso de restauración cuando la conexión se cae

## Solución Detallada

<TroubleshootingItem id="improved-restore-script" summary="Script Mejorado para Restauración de Base de Datos">

El script mejorado de restauración incluye varias optimizaciones:

```bash
#!/bin/bash
# Script mejorado para restauración de base de datos

set -e

# Configuración
DUMP_DIR="/data/dumps"
LOG_FILE="/data/logs/restore_$(date +%Y%m%d_%H%M%S).log"
MAX_DUMP_AGE_DAYS=7

# Función para limpiar volcados antiguos
clean_old_dumps() {
    echo "Limpiando volcados con más de ${MAX_DUMP_AGE_DAYS} días..." | tee -a $LOG_FILE
    find $DUMP_DIR -name "*.sql" -type f -mtime +$MAX_DUMP_AGE_DAYS -delete
    find $DUMP_DIR -name "*.dump" -type f -mtime +$MAX_DUMP_AGE_DAYS -delete
    echo "Volcados antiguos limpiados con éxito" | tee -a $LOG_FILE
}

# Función para verificar espacio disponible
check_disk_space() {
    AVAILABLE_SPACE=$(df $DUMP_DIR | awk 'NR==2 {print $4}')
    REQUIRED_SPACE=1048576  # 1GB en KB

    if [ $AVAILABLE_SPACE -lt $REQUIRED_SPACE ]; then
        echo "Advertencia: Espacio en disco bajo. Disponible: ${AVAILABLE_SPACE}KB" | tee -a $LOG_FILE
        clean_old_dumps
    fi
}

# Función principal de restauración
t_restore_database() {
    local dump_file=$1
    local database_name=$2

    echo "Iniciando restauración de base de datos: $dump_file -> $database_name" | tee -a $LOG_FILE
    echo "Hora de inicio: $(date)" | tee -a $LOG_FILE

    # Restaurar con monitoreo de progreso
    pv $dump_file | psql -h $DB_HOST -U $DB_USER -d $database_name 2>&1 | tee -a $LOG_FILE

    echo "Restauración completada a las: $(date)" | tee -a $LOG_FILE
}

# Verificaciones previas a la restauración
check_disk_space
clean_old_dumps

# Ejecutar restauración
restore_database "$1" "$2"
```

</TroubleshootingItem>

<TroubleshootingItem id="tmux-session-management" summary="Uso de tmux para Resiliencia en la Conexión">

Para manejar caídas de conexión durante operaciones largas de restauración, use tmux:

```bash
# Iniciar una nueva sesión tmux para la restauración
kubectl exec -it <nombre-del-pod> -- tmux new-session -d -s restore

# Adjuntarse a la sesión
kubectl exec -it <nombre-del-pod> -- tmux attach-session -t restore

# Dentro de la sesión tmux, ejecutar la restauración
./restore_script.sh /data/dumps/production_dump.sql production_db

# Desconectarse de la sesión (Ctrl+b, luego d)
# La sesión sigue ejecutándose incluso si la conexión se cae

# Volver a conectarse después para verificar el progreso
kubectl exec -it <nombre-del-pod> -- tmux attach-session -t restore

# Listar todas las sesiones
kubectl exec -it <nombre-del-pod> -- tmux list-sessions
```

**Beneficios de usar tmux:**

- Persistencia de sesión ante caídas de conexión
- Capacidad para monitorear el progreso remotamente
- Múltiples ventanas para operaciones paralelas
- Compartición de sesión entre miembros del equipo

</TroubleshootingItem>

<TroubleshootingItem id="volume-space-management" summary="Gestión del Espacio en Volumen del Pod">

Para prevenir problemas de espacio en volumen durante las operaciones de restauración:

```yaml
# Configuración del pod con almacenamiento adecuado
apiVersion: v1
kind: Pod
metadata:
  name: db-restore-pod
spec:
  containers:
    - name: restore-container
      image: postgres:14
      volumeMounts:
        - name: dump-storage
          mountPath: /data/dumps
        - name: logs-storage
          mountPath: /data/logs
      resources:
        requests:
          storage: "50Gi" # Espacio adecuado para volcados
  volumes:
    - name: dump-storage
      persistentVolumeClaim:
        claimName: dump-pvc
    - name: logs-storage
      emptyDir: {}
```

**Comandos para gestión de espacio:**

```bash
# Verificar uso actual
kubectl exec -it <nombre-del-pod> -- df -h /data/dumps

# Limpiar volcados antiguos manualmente
kubectl exec -it <nombre-del-pod> -- find /data/dumps -name "*.sql" -mtime +7 -delete

# Monitorear espacio durante la restauración
kubectl exec -it <nombre-del-pod> -- watch "df -h /data/dumps"
```

</TroubleshootingItem>

<TroubleshootingItem id="monitoring-restore-progress" summary="Monitoreo del Progreso de la Restauración">

Para monitorear el proceso de restauración de manera efectiva:

```bash
# Usando pv (pipe viewer) para monitoreo de progreso
kubectl exec -it <nombre-del-pod> -- pv /data/dumps/large_dump.sql | psql -h localhost -U postgres -d target_db

# Monitorear logs en tiempo real
kubectl exec -it <nombre-del-pod> -- tail -f /data/logs/restore_*.log

# Verificar crecimiento del tamaño de la base de datos
kubectl exec -it <nombre-del-pod> -- psql -h localhost -U postgres -c "SELECT pg_size_pretty(pg_database_size('target_db'));"

# Monitorear conexiones activas
kubectl exec -it <nombre-del-pod> -- psql -h localhost -U postgres -c "SELECT count(*) FROM pg_stat_activity WHERE datname='target_db';"
```

**Script para monitoreo de progreso:**

```bash
#!/bin/bash
# progress_monitor.sh

DB_NAME=$1
while true; do
    SIZE=$(psql -h localhost -U postgres -t -c "SELECT pg_size_pretty(pg_database_size('$DB_NAME'));")
    echo "$(date): Tamaño de la base de datos: $SIZE"
    sleep 30
done
```
