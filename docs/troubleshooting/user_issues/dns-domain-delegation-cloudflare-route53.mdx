---
sidebar_position: 3
title: "DNS Domain Delegation Issues Between CloudFlare and Route53"
description: "Resolving domain delegation and validation issues when using external DNS providers with SleakOps"
date: "2024-12-21"
category: "provider"
tags: ["dns", "route53", "cloudflare", "domain-delegation", "aws"]
---

import TroubleshootingItem from "@site/src/components/HomepageFeatures/troubleshootingitem";

# DNS Domain Delegation Issues Between CloudFlare and Route53

**Date:** December 21, 2024  
**Category:** Provider  
**Tags:** DNS, Route53, CloudFlare, Domain Delegation, AWS

## Problem Description

**Context:** Users experience domain validation issues when trying to use SleakOps with domains managed by external DNS providers like CloudFlare, while SleakOps expects domains to be delegated to AWS Route53.

**Observed Symptoms:**

- Domain validation fails for main domains managed in CloudFlare
- Subdomain aliases cannot be validated (e.g., teams.simplee.cl)
- SSL certificate creation fails with validation errors
- Inconsistent behavior where some subdomains work while others don't
- NS records mismatch between what SleakOps expects and actual delegation

**Relevant Configuration:**

- Main domain: Managed in CloudFlare
- DNS provider: External (CloudFlare) vs Expected (Route53)
- SSL validation: Requires proper domain delegation
- SleakOps validation: Checks delegation once during setup

**Error Conditions:**

- Domain validation fails when NS records don't point to Route53
- SSL certificate validation errors occur
- Subdomain creation blocked due to delegation issues
- Mixed DNS management causes inconsistent behavior

## Detailed Solution

<TroubleshootingItem id="understanding-dns-management" summary="Understanding SleakOps DNS Management">

**How SleakOps manages DNS:**

1. **Centralized Management**: SleakOps centralizes all DNS management in your AWS accounts through Route53
2. **Automatic Service Management**: Services deployed with SleakOps manage their DNS records automatically
3. **Manual Configuration**: Additional rules (email validation, external services) must be configured manually in Route53
4. **Single Validation**: SleakOps validates domain delegation only once during initial setup

**Where to view generated DNS records:**

- All DNS records generated by SleakOps are visible in the platform
- Records include all environments, executions, and aliases you create
- Records are automatically managed for SleakOps services

</TroubleshootingItem>

<TroubleshootingItem id="delegation-requirements" summary="Domain Delegation Requirements">

**For proper functionality, domains must be:**

1. **Fully delegated to Route53**: Main domain NS records point to Route53 nameservers
2. **Subdomains of SleakOps-managed domains**: Created as subdomains of already delegated domains

**Validation process:**

```bash
# Check current NS records
dig NS simplee.cl

# Compare with Route53 nameservers
# Should match the NS records shown in SleakOps platform
```

**Common delegation issues:**

- NS records in domain registrar don't match Route53 nameservers
- Partial delegation (some subdomains work, others don't)
- CloudFlare proxy interfering with validation

</TroubleshootingItem>

<TroubleshootingItem id="cloudflare-migration" summary="Migrating from CloudFlare to Route53">

**Complete migration steps:**

1. **Export existing DNS records from CloudFlare**

   - Download all existing DNS records
   - Document any special configurations

2. **Create Route53 hosted zone**

   - SleakOps creates this automatically when you add a domain
   - Note the provided nameservers

3. **Update domain registrar**

   ```
   # Change NS records at your domain registrar to:
   ns-xxx.awsdns-xx.com
   ns-xxx.awsdns-xx.co.uk
   ns-xxx.awsdns-xx.net
   ns-xxx.awsdns-xx.org
   ```

4. **Recreate necessary records in Route53**

   - Manually add any custom DNS records
   - Configure email validation records
   - Set up external service records

5. **Wait for propagation**
   - DNS changes can take up to 48 hours to propagate
   - Verify with `dig` or online DNS checkers

</TroubleshootingItem>

<TroubleshootingItem id="ssl-certificate-issues" summary="Resolving SSL Certificate Validation">

**SSL certificate validation requirements:**

1. **Remove CloudFlare proxy**: Disable orange cloud (proxy) in CloudFlare for validation records
2. **Proper delegation**: Ensure domain is properly delegated to Route53
3. **DNS propagation**: Wait for DNS changes to propagate globally

**Troubleshooting SSL validation:**

```bash
# Check if domain resolves to correct nameservers
dig NS your-domain.com

# Verify TXT records for SSL validation
dig TXT _acme-challenge.your-domain.com

# Test domain resolution
nslookup your-domain.com
```

**Common fixes:**

- Disable CloudFlare proxy during certificate validation
- Ensure all NS records point to Route53
- Wait for DNS propagation (up to 48 hours)

</TroubleshootingItem>

<TroubleshootingItem id="mixed-dns-management" summary="Managing Mixed DNS Scenarios">

**If you need to keep some DNS in CloudFlare:**

1. **Subdomain delegation**: Delegate only specific subdomains to Route53

   ```
   # In CloudFlare, create NS records for subdomains:
   app.yourdomain.com NS ns-xxx.awsdns-xx.com
   app.yourdomain.com NS ns-xxx.awsdns-xx.co.uk
   app.yourdomain.com NS ns-xxx.awsdns-xx.net
   app.yourdomain.com NS ns-xxx.awsdns-xx.org
   ```

2. **Use SleakOps subdomains**: Create all SleakOps services under a dedicated subdomain
   - Example: `*.apps.yourdomain.com` managed by Route53
   - Main domain remains in CloudFlare

**Potential issues with mixed management:**

- Validation bugs may occur with frequent domain changes
- Inconsistent behavior between different subdomains
- SSL certificate validation complications

</TroubleshootingItem>

<TroubleshootingItem id="troubleshooting-validation" summary="Troubleshooting Domain Validation">

**Common validation problems:**

1. **NS record mismatch**

   ```bash
   # Check what NS records are actually set
   dig +short NS yourdomain.com

   # Compare with SleakOps expected NS records
   # (visible in SleakOps platform)
   ```

2. **Propagation delays**
   - Use multiple DNS checkers: whatsmydns.net
