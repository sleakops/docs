---
sidebar_position: 3
title: "OpenTelemetry Database Detection Issue in Django"
description: "Solution for OpenTelemetry not detecting configured databases in Django applications"
date: "2024-12-19"
category: "workload"
tags: ["opentelemetry", "django", "database", "monitoring", "instrumentation"]
---

import TroubleshootingItem from "@site/src/components/HomepageFeatures/troubleshootingitem";

# OpenTelemetry Database Detection Issue in Django

**Date:** December 19, 2024  
**Category:** Workload  
**Tags:** OpenTelemetry, Django, Database, Monitoring, Instrumentation

## Problem Description

**Context:** User has a Django application deployed in SleakOps with OpenTelemetry auto-instrumentation enabled, but OpenTelemetry is not detecting the configured database connections despite the database being properly configured in the Django settings.

**Observed Symptoms:**

- OpenTelemetry auto-instrumentation is not detecting database connections
- Database is properly configured and working in the Django application
- Adding `DJANGO_SETTINGS_MODULE` environment variable does not resolve the issue
- Application functions normally but lacks database telemetry data

**Relevant Configuration:**

- Framework: Django (Django REST Framework)
- Environment variable: `DJANGO_SETTINGS_MODULE="simplee_drf.settings"`
- Platform: SleakOps with OpenTelemetry auto-instrumentation
- Previous issue with boto library was resolved by updating version

**Error Conditions:**

- OpenTelemetry fails to detect database during application startup
- Missing database traces and metrics in observability data
- Issue persists after setting Django settings module environment variable

## Detailed Solution

<TroubleshootingItem id="django-settings-verification" summary="Verify Django Settings Configuration">

First, ensure your Django settings are properly configured for database detection:

1. **Verify DJANGO_SETTINGS_MODULE is correctly set:**

```yaml
# In your SleakOps deployment configuration
environment:
  DJANGO_SETTINGS_MODULE: "your_project.settings"
  # Replace 'your_project' with your actual project name
```

2. **Check your Django settings file contains database configuration:**

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',  # or your database engine
        'NAME': os.environ.get('DB_NAME'),
        'USER': os.environ.get('DB_USER'),
        'PASSWORD': os.environ.get('DB_PASSWORD'),
        'HOST': os.environ.get('DB_HOST'),
        'PORT': os.environ.get('DB_PORT', '5432'),
    }
}
```

</TroubleshootingItem>

<TroubleshootingItem id="opentelemetry-instrumentation" summary="Configure OpenTelemetry Django Instrumentation">

Ensure OpenTelemetry Django instrumentation is properly configured:

1. **Add required OpenTelemetry packages to requirements.txt:**

```txt
opentelemetry-api
opentelemetry-sdk
opentelemetry-auto-instrumentation
opentelemetry-instrumentation-django
opentelemetry-instrumentation-psycopg2  # for PostgreSQL
# or opentelemetry-instrumentation-mysqlclient  # for MySQL
```

2. **Configure instrumentation in Django settings:**

```python
# settings.py
from opentelemetry.instrumentation.django import DjangoInstrumentor
from opentelemetry.instrumentation.psycopg2 import Psycopg2Instrumentor

# Initialize instrumentors
DjangoInstrumentor().instrument()
Psycopg2Instrumentor().instrument()
```

</TroubleshootingItem>

<TroubleshootingItem id="environment-variables" summary="Set Required Environment Variables">

Configure the necessary environment variables in your SleakOps deployment:

```yaml
# SleakOps deployment configuration
environment:
  # Django configuration
  DJANGO_SETTINGS_MODULE: "your_project.settings"

  # Database configuration
  DB_NAME: "your_database_name"
  DB_USER: "your_database_user"
  DB_PASSWORD: "your_database_password"
  DB_HOST: "your_database_host"
  DB_PORT: "5432"

  # OpenTelemetry configuration
  OTEL_SERVICE_NAME: "your-django-app"
  OTEL_RESOURCE_ATTRIBUTES: "service.name=your-django-app,service.version=1.0.0"
  OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
```

</TroubleshootingItem>

<TroubleshootingItem id="manual-instrumentation" summary="Manual Database Instrumentation (Alternative)">

If auto-instrumentation continues to fail, configure manual instrumentation:

1. **Create an instrumentation module:**

```python
# instrumentation.py
from opentelemetry import trace
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.instrumentation.django import DjangoInstrumentor
from opentelemetry.instrumentation.psycopg2 import Psycopg2Instrumentor

def setup_telemetry():
    # Set up tracer provider
    trace.set_tracer_provider(TracerProvider())
    tracer = trace.get_tracer_provider()

    # Set up OTLP exporter
    otlp_exporter = OTLPSpanExporter()
    span_processor = BatchSpanProcessor(otlp_exporter)
    tracer.add_span_processor(span_processor)

    # Instrument Django and database
    DjangoInstrumentor().instrument()
    Psycopg2Instrumentor().instrument()
```

2. **Initialize in Django's ready() method:**

```python
# apps.py
from django.apps import AppConfig

class YourAppConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'your_app'

    def ready(self):
        from .instrumentation import setup_telemetry
        setup_telemetry()
```

</TroubleshootingItem>

<TroubleshootingItem id="troubleshooting-steps" summary="Troubleshooting and Verification">

**Verify instrumentation is working:**

1. **Check application logs for OpenTelemetry initialization:**

```bash
# Look for these log messages in SleakOps logs
kubectl logs -f deployment/your-app | grep -i "opentelemetry\|instrumentation"
```

2. **Test database connection manually:**

```python
# In Django shell or a test view
from django.db import connection

def test_db_connection():
    with connection.cursor() as cursor:
        cursor.execute("SELECT 1")
        result = cursor.fetchone()
    return result
```

3. **Verify telemetry data is being sent:**

```python
# Add to a Django view for testing
from opentelemetry import trace
\
```
